---
// @ts-nocheck
interface Props {
  title?: string;
  description?: string;
  diagramUrl?: string;
  features?: Array<{
    title: string;
    desc: string;
  }>;
  components?: Array<{
    id: number;
    name: string;
    img: string;
    x: number;
    y: number;
  }>;
}

const {
  title = "Technical Information",
  description = "Discover the technical specifications and components of our systems.",
  diagramUrl = "https://images.unsplash.com/photo-1628744876497-eb30460be9f6?q=80&w=1200&auto=format&fit=crop",
  features = [],
  components = []
} = Astro.props as Props;
---

<section class="section-structural">
  <div class="section-wrap">
    <h1 class="tech-title">Technical Information</h1>

    <!-- Features -->
    <div class="feature-grid" id="feature-grid">
      {features.map((feature, idx) => (
        <div class="feature-box" style={`--delay: ${(idx % 3) + 1}`}>
          <div class="feature-header">{feature.title}</div>
          <p class="feature-text">{feature.desc}</p>
        </div>
      ))}
    </div>

    <div class="layout">
      <!-- Info Panel -->
      <div class="info-panel">
        <h3 id="panel-title">{title}</h3>
        <p class="info-desc" id="panel-desc">
          {description}
        </p>

        <div class="grid-cards" id="cards-grid">
          {components.map((component, idx) => (
            <div class="card" data-id={component.id} style={`--delay: ${(idx % 2) + 1}`}>
              <div class="card-meta">
                <div class="card-id">{component.id}</div>
                <div class="card-name">{component.name}</div>
              </div>
              <div class="card-img">
                <img class="card-img-src" src={component.img} alt={component.name} />
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- Visualizer -->
      <div class="vis-container">
        <div class="vis-frame">
          <img id="main-diagram" class="vis-img" src={diagramUrl} alt="Technical Diagram" />
          <div class="marker-layer" id="markers-layer">
            {components.map((component) => (
              <div
                class="marker"
                data-id={component.id}
                style={`left: ${component.x}%; top: ${component.y}%;`}
              >
                <div class="tooltip">{component.name}</div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // @ts-nocheck
  document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('.card');
    const markers = document.querySelectorAll('.marker');

    // Link card and marker interactions
    cards.forEach(card => {
      const cardId = card.dataset.id;
      const correspondingMarker = document.querySelector(`.marker[data-id="${cardId}"]`);

      const onEnter = () => {
        card.classList.add('active');
        if (correspondingMarker) correspondingMarker.classList.add('active');
      };

      const onLeave = () => {
        card.classList.remove('active');
        if (correspondingMarker) correspondingMarker.classList.remove('active');
      };

      card.addEventListener('mouseenter', onEnter);
      card.addEventListener('mouseleave', onLeave);
    });

    markers.forEach(marker => {
      const markerId = marker.dataset.id;
      const correspondingCard = document.querySelector(`.card[data-id="${markerId}"]`);

      const onEnter = () => {
        if (correspondingCard) correspondingCard.classList.add('active');
        marker.classList.add('active');
      };

      const onLeave = () => {
        if (correspondingCard) correspondingCard.classList.remove('active');
        marker.classList.remove('active');
      };

      marker.addEventListener('mouseenter', onEnter);
      marker.addEventListener('mouseleave', onLeave);
    });

    // Intersection Observer for animations
    const initObserver = () => {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('in-view');
            }
          });
        },
        { threshold: 0.1 }
      );

      const targets = [
        document.querySelector('.tech-title'),
        ...document.querySelectorAll('.feature-box'),
        document.querySelector('.info-panel'),
        ...document.querySelectorAll('.card'),
        document.querySelector('.vis-container')
      ];

      targets.forEach(t => {
        if (t) observer.observe(t);
      });
    };

    initObserver();
  });
</script>
