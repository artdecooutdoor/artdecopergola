---
// @ts-nocheck
import Layout from '../../../layouts/layout.astro';
import { getLangFromUrl, useTranslations } from '../../../i18n/index';
import Hero from '../../../components/hero.astro';
import '../../../styles/pages/products/retractable-pergola-roof.css';
import Button from '../../../components/button.astro';
import Somfy from '../../../components/somfy.astro';

// @ts-ignore
export function getStaticPaths() {
  return [
    { params: { lang: 'en' } },
    { params: { lang: 'ru' } },
    { params: { lang: 'az' } },
  ];
}

// @ts-ignore
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<Layout title={t('retractablePergolaRoof.title')}>
			<!-- HERO SECTION -->
		<Hero 
			title={t('retractablePergolaRoof.heroTitle')}
			description={[
				t('retractablePergolaRoof.heroDesc1'),
				t('retractablePergolaRoof.heroDesc2')
			]}
			image="/images/products/retractable-pergola-roofs.webp"
			imageAlt="Retractable Pergola Roof System"
			buttonText={t('retractablePergolaRoof.orderNow')}
			buttonHref={`/${lang}/contact`}
			buttonVariant="premium"
		/>
	<main>
		<!-- PERGOLA CONFIGURATOR SECTION -->
		<div class="main-container">
			<!-- HEADER -->
			<header class="section-header">
				<h1 set:html={t('retractablePergolaRoof.sectionTitle')}></h1>
			</header>

			<!-- SECTION 1: MODEL SELECTOR -->
			<section id="model-selector" class="model-selector-grid">
				<!-- Injected via JS -->
			</section>

			<!-- SECTION 2: STRUCTURAL DETAILS -->
			<section id="structural-section" class="structural-section">
				<div class="layout">
					<!-- Left: Info & Components -->
					<div class="structural-info">
						<h2 id="model-title">BARITONE</h2>
						<p id="model-desc" class="structural-desc">
							{t('retractablePergolaRoof.barToneDesc')}
						</p>
						
						<div id="component-list" class="grid-cards">
							<!-- Component Cards Injected via JS -->
						</div>
					</div>

					<!-- Right: Diagram -->
					<div class="vis-container">
						<div class="vis-frame">
							<div class="vis-frame-img">
								<img id="diagram-image" class="diagram-img" src="" alt="Technical Diagram" />
								<div id="marker-container" class="marker-layer">
									<!-- Markers Injected via JS -->
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>

		<!-- SECTION 1: MECHANICAL DATA -->
		<section class="pergola-section mechanical-section">
			<div class="col col-image">
				<img 
					src="/images/products/retractable-pergola-roof/details/membrane.webp" 
					alt="Mechanical Detail" 
					class="bg-image anim-fade-in"
				/>
			</div>

			<div class="col col-text padding-right">
					<a href="https://www.sergeferrari.com" class="serge-ferrari-logo">
						<img 
						src="/images/logos/serge-ferrari.svg" 
						alt="Serge Ferrari Logo" 
						class="logo-products"
					/>
				</a>
				<div class="item-block anim-fade-up delay-100">
					<h3 class="item-title">{t('retractablePergolaRoof.durabilityTitle')}</h3>
					<p class="item-text">
						{t('retractablePergolaRoof.durabilityText')}
					</p>
				</div>

				<div class="item-block anim-fade-up delay-200">
					<h3 class="item-title" set:html={t('retractablePergolaRoof.soundAbsorptionTitle')}></h3>
					<p class="item-text">
							{t('retractablePergolaRoof.aestheticText')}
						</p>
					</div>

					<div class="item-block anim-fade-up delay-300">
						<h3 class="item-title">{t('retractablePergolaRoof.sustainabilityTitle')}</h3>
						<p class="item-text">
							{t('retractablePergolaRoof.sustainabilityText')}
						</p>
					</div>
					<Button variant="cta" text={t('retractablePergolaRoof.orderNow')} href="#" onclick="event.preventDefault(); document.querySelector('footer').scrollIntoView({behavior: 'smooth', block: 'start'}); " />
				</div>
			</div>
		</section>

		<!-- SECTION 2: SOMFY -->
		<Somfy />

		<div class="main-container">
			<!-- SECTION 3: COLOR OPTIONS -->
			<section class="color-options-section" id="color-options-component">
				<div class="co-title-wrapper">
					<h2 class="co-title">
						<span>{t('retractablePergolaRoof.colorOptionsTitle')}</span>
					</h2>
				</div>
				
				<div class="co-desc-wrapper">
					<p class="co-description">
						{t('retractablePergolaRoof.colorDesc')}
					</p>
				</div>

				<div class="co-swatches-wrapper">
					<div id="swatch-list" class="co-swatches-container"></div>
				</div>

				<div class="co-btn-wrapper">
				<Button variant="premium" text={t('retractablePergolaRoof.orderNow')} href={`/${lang}/contact`} />
			</div>

				<div class="co-image-wrapper">
					<div class="co-glow-container">
						<img id="product-display" class="co-product-image" src="" alt="Pergola Color Visualization" />
					</div>
				</div>
			</section>

		</div>
	</main>
</Layout>

<script is:inline define:vars={{ 
	barToneDescText: t('retractablePergolaRoof.barToneDesc'),
	tenorDescText: t('retractablePergolaRoof.tenorDesc'),
	sopranoDescText: t('retractablePergolaRoof.sopranoDesc'),
	altoDescText: t('retractablePergolaRoof.altoDesc')
}}>
	window.pergolaTranslations = {
		barTone: barToneDescText,
		tenor: tenorDescText,
		soprano: sopranoDescText,
		alto: altoDescText
	};
</script>

<script>
	// @ts-nocheck
	/**
	 * APPLICATION STATE & DATA
	 */

	// 1. Model Data
	const models = {
		baritone: {
			name: 'BARITONE',
			thumb: '/images/products/retractable-pergola-roof/baritone/RAL9016.webp', 
			desc: window.pergolaTranslations?.barTone || 'Baritone description',
			diagram: "/images/products/retractable-pergola-roof/baritone/RAL9016.webp", 
			markers: [
				{ id: 1, x: 57, y: 10 },
				{ id: 2, x: 7, y: 19 },
				{ id: 3, x: 26.5, y: 30 },
				{ id: 4, x: 94, y: 30 },
				{ id: 5, x: 44.5, y: 75 }
			],
			components: [
				{ id: 1, name: "Drive arm", img: "/images/products/retractable-pergola-roof/details/drive-arm.webp" },
				{ id: 2, name: "Blade profile", img: "/images/products/retractable-pergola-roof/details/blade-profile.webp" },
				{ id: 3, name: "Drive rod profile", img: "/images/products/retractable-pergola-roof/details/drive-rod-profile.webp" },
				{ id: 4, name: "Main beam profile", img: "/images/products/retractable-pergola-roof/details/main-beam-profile.webp" },
				{ id: 5, name: "Linkage clip", img: "/images/products/retractable-pergola-roof/details/linkage-clip.webp" }
			]
		},
		tenor: {
			name: 'TENOR',
			thumb: '/images/products/retractable-pergola-roof/tenor/RAL9016.webp',
			desc: window.pergolaTranslations?.tenor || 'Tenor description',
			diagram: "/images/products/retractable-pergola-roof/tenor/RAL9016.webp",
			markers: [
				{ id: 1, x: 47, y: 10 },
				{ id: 2, x: 7, y: 23 },
				{ id: 3, x: 29, y: 33 },
				{ id: 4, x: 92, y: 31 },
				{ id: 5, x: 55.5, y: 75 }
			],
			components: [
				{ id: 1, name: "Drive arm", img: "/images/products/retractable-pergola-roof/details/drive-arm.webp" },
				{ id: 2, name: "Blade profile", img: "/images/products/retractable-pergola-roof/details/blade-profile.webp" },
				{ id: 3, name: "Drive rod profile", img: "/images/products/retractable-pergola-roof/details/drive-rod-profile.webp" },
				{ id: 4, name: "Post profile", img: "/images/products/retractable-pergola-roof/details/post-profile.webp" },
				{ id: 5, name: "Post base cover", img: "/images/products/retractable-pergola-roof/details/post-base-cover.webp" }
			]
		},
		soprano: {
			name: 'SOPRANO',
			thumb: '/images/products/retractable-pergola-roof/soprano/RAL9016.webp',
			desc: window.pergolaTranslations?.soprano || 'Soprano description',
			diagram: "/images/products/retractable-pergola-roof/soprano/RAL9016.webp",
			markers: [
				{ id: 1, x: 47, y: 36 },
				{ id: 2, x: 7, y: 54 },
				{ id: 3, x: 29, y: 67 },
				{ id: 4, x: 92, y: 61 },
			],
			components: [
				{ id: 1, name: "Drive arm", img: "/images/products/retractable-pergola-roof/details/drive-arm.webp" },
				{ id: 2, name: "Blade profile", img: "/images/products/retractable-pergola-roof/details/blade-profile.webp" },
				{ id: 3, name: "Drive rod profile", img: "/images/products/retractable-pergola-roof/details/drive-rod-profile.webp" },
				{ id: 4, name: "Post profile", img: "/images/products/retractable-pergola-roof/details/post-profile.webp" },
			]
		},
		alto: {
			name: 'ALTO',
			thumb: '/images/products/retractable-pergola-roof/alto/RAL9016.webp',
			desc: window.pergolaTranslations?.alto || 'Alto description',
			diagram: "/images/products/retractable-pergola-roof/alto/RAL9016.webp",
			markers: [
				{ id: 1, x: 47, y: 14 },
				{ id: 2, x: 10, y: 28 },
				{ id: 3, x: 29, y: 45 },
				{ id: 4, x: 94, y: 35 },
				{ id: 5, x: 55.5, y: 75 }
			],
			components: [
				{ id: 1, name: "Drive arm", img: "/images/products/retractable-pergola-roof/details/drive-arm.webp" },
				{ id: 2, name: "Blade profile", img: "/images/products/retractable-pergola-roof/details/blade-profile.webp" },
				{ id: 3, name: "Drive rod profile", img: "/images/products/retractable-pergola-roof/details/drive-rod-profile.webp" },
				{ id: 4, name: "Wall profile", img: "/images/products/retractable-pergola-roof/details/wall-profile.webp" },
				{ id: 5, name: "Post base cover", img: "/images/products/retractable-pergola-roof/details/post-base-cover.webp" }
			]
		}
	};

	// 2. Color Data
	const ralColors = [
		{ code: '9016', hex: '#F7F9F9', text: '#3E464C', border: '#DCE0E0' },
		{ code: '1013', hex: '#EBE2CD', text: '#3E464C', border: '#D0C4A8' },
		{ code: '8014', hex: '#4F3D35', text: '#D1D9D1', border: '#5A483E' },
		{ code: '8019', hex: '#3E3230', text: '#D1D9D1', border: '#5D4B48' },
		{ code: '9005', hex: '#1C1C1C', text: '#D1D9D1', border: '#444444' },
		{ code: '7016', hex: '#31373D', text: '#D1D9D1', border: '#5D676E' }
	];

	const colorImages = {
		'baritone': {
			'9016': '/images/products/retractable-pergola-roof/baritone/RAL9016.webp',
			'1013': '/images/products/retractable-pergola-roof/baritone/RAL1013.webp',
			'8014': '/images/products/retractable-pergola-roof/baritone/RAL8014.webp',
			'8019': '/images/products/retractable-pergola-roof/baritone/RAL8019.webp',
			'9005': '/images/products/retractable-pergola-roof/baritone/RAL9005.webp',
			'7016': '/images/products/retractable-pergola-roof/baritone/RAL7016.webp'
		},
		'tenor': {
			'9016': '/images/products/retractable-pergola-roof/tenor/RAL9016.webp',
			'1013': '/images/products/retractable-pergola-roof/tenor/RAL1013.webp',
			'8014': '/images/products/retractable-pergola-roof/tenor/RAL8014.webp',
			'8019': '/images/products/retractable-pergola-roof/tenor/RAL8019.webp',
			'9005': '/images/products/retractable-pergola-roof/tenor/RAL9005.webp',
			'7016': '/images/products/retractable-pergola-roof/tenor/RAL7016.webp'
		},
		'soprano': {
			'9016': '/images/products/retractable-pergola-roof/soprano/RAL9016.webp',
			'1013': '/images/products/retractable-pergola-roof/soprano/RAL1013.webp',
			'8014': '/images/products/retractable-pergola-roof/soprano/RAL8014.webp',
			'8019': '/images/products/retractable-pergola-roof/soprano/RAL8019.webp',
			'9005': '/images/products/retractable-pergola-roof/soprano/RAL9005.webp',
			'7016': '/images/products/retractable-pergola-roof/soprano/RAL7016.webp'
		},
		'alto': {
			'9016': '/images/products/retractable-pergola-roof/alto/RAL9016.webp',
			'1013': '/images/products/retractable-pergola-roof/alto/RAL1013.webp',
			'8014': '/images/products/retractable-pergola-roof/alto/RAL8014.webp',
			'8019': '/images/products/retractable-pergola-roof/alto/RAL8019.webp',
			'9005': '/images/products/retractable-pergola-roof/alto/RAL9005.webp',
			'7016': '/images/products/retractable-pergola-roof/alto/RAL7016.webp'
		}
	};

	// State
	let currentModel = 'baritone';
	let currentColor = '9016';

	// DOM Elements
	const modelSelector = document.getElementById('model-selector');
	const titleEl = document.getElementById('model-title');
	const descEl = document.getElementById('model-desc');
	const compListEl = document.getElementById('component-list');
	const diagramImg = document.getElementById('diagram-image');
	const markerContainer = document.getElementById('marker-container');
	const colorSwatchList = document.getElementById('swatch-list');
	const productDisplay = document.getElementById('product-display');

	function init() {
		renderModelSelector();
		renderColorSwatches();
		
		// Initial Render
		selectModel('baritone');
	}

	/* 
	 * LOGIC: MODEL SELECTOR
	 */
	function renderModelSelector() {
		modelSelector!.innerHTML = '';
		Object.keys(models).forEach(key => {
			const m = models[key as keyof typeof models];
			const card = document.createElement('div');
			card.className = 'model-card';
			card.dataset.model = key;
			card.innerHTML = `
				<img src="${m.thumb}" alt="${m.name}" />
				<div class="model-card-footer">${m.name}</div>
			`;
			card.addEventListener('click', () => selectModel(key));
			modelSelector!.appendChild(card);
		});
	}

	function selectModel(key: string) {
		currentModel = key;
		document.querySelectorAll('.model-card').forEach(c => {
			c.classList.toggle('active', c.dataset.model === key);
		});
		const data = models[key as keyof typeof models];
		titleEl!.textContent = data.name;
		descEl!.textContent = data.desc;
		
		diagramImg!.style.opacity = '0';
		setTimeout(() => {
			diagramImg!.src = data.diagram;
			diagramImg!.onload = () => { diagramImg!.style.opacity = '1'; };
		}, 200);

		renderStructuralDetails(data);
		updateColorImage(currentModel, currentColor);
	}

	/* 
	 * LOGIC: STRUCTURAL DETAILS
	 */
	function renderStructuralDetails(data: any) {
		// Components (Left Side)
		compListEl!.innerHTML = '';
		data.components.forEach((c: any) => {
			const el = document.createElement('div');
			el.className = 'card';
			el.dataset.id = c.id; 
			
			el.innerHTML = `
				<div class="card-meta">
					<div class="card-id">${c.id}</div>
					<div class="card-name">${c.name}</div>
				</div>
				<div class="card-img">
					<img class="card-img-src" src="${c.img}" alt="${c.name}" />
				</div>
			`;
			el.addEventListener('mouseenter', () => highlightMarker(c.id, true));
			el.addEventListener('mouseleave', () => highlightMarker(c.id, false));
			compListEl!.appendChild(el);
		});

		// Markers (Right Side)
		markerContainer!.innerHTML = '';
		data.markers.forEach((m: any) => {
			const comp = data.components.find((c: any) => c.id === m.id);
			const tooltipText = comp ? comp.name : '';

			const el = document.createElement('div');
			el.className = 'marker';
			el.dataset.id = m.id;
			el.style.left = m.x + '%';
			el.style.top = m.y + '%';
			
			el.innerHTML = `<div class="tooltip">${tooltipText}</div>`;
			
			el.addEventListener('mouseenter', () => highlightCard(m.id, true));
			el.addEventListener('mouseleave', () => highlightCard(m.id, false));

			markerContainer!.appendChild(el);
		});
	}

	function highlightMarker(id: number, isActive: boolean) {
		const marker = markerContainer!.querySelector(`.marker[data-id="${id}"]`);
		if(marker) {
			if (isActive) {
				marker.classList.add('active');
			} else {
				marker.classList.remove('active');
			}
		}
	}
	
	function highlightCard(id: number, isActive: boolean) {
		const card = compListEl!.querySelector(`.card[data-id="${id}"]`);
		if(card) {
			if (isActive) {
				card.classList.add('active');
			} else {
				card.classList.remove('active');
			}
		}
	}

	/* 
	 * LOGIC: COLOR OPTIONS
	 */
	function renderColorSwatches() {
		colorSwatchList!.innerHTML = '';
		ralColors.forEach((color, index) => {
			const btn = document.createElement('button');
			btn.className = 'co-swatch';
			if(index === 0) btn.classList.add('selected'); 
			
			btn.style.backgroundColor = color.hex;
			btn.style.borderColor = color.border;
			btn.style.color = color.text;

			const label = document.createElement('span');
			label.className = 'co-swatch-label';
			label.textContent = `RAL ${color.code}`;
			btn.appendChild(label);

			btn.addEventListener('click', () => {
				selectColor(color.code, btn);
			});

			colorSwatchList!.appendChild(btn);
		});
	}

	function selectColor(code: string, btn: HTMLButtonElement) {
		if(currentColor === code) return;
		currentColor = code;
		document.querySelectorAll('.co-swatch').forEach(b => b.classList.remove('selected'));
		btn.classList.add('selected');
		updateColorImage(currentModel, currentColor);
	}

	function updateColorImage(modelKey: string, colorCode: string) {
		let src = '';
		if (colorImages[modelKey as keyof typeof colorImages] && colorImages[modelKey as keyof typeof colorImages]![colorCode]) {
			src = colorImages[modelKey as keyof typeof colorImages]![colorCode];
		} else {
			src = 'https://via.placeholder.com/800x800?text=No+Image';
		}

		productDisplay!.style.opacity = '0';
		setTimeout(() => {
			productDisplay!.src = src;
			productDisplay!.onload = () => {
				productDisplay!.style.opacity = '1';
			};
		}, 200);
	}

	// Run on page load
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', init);
	} else {
		init();
	}
</script>
